<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rental Admin - Bookings</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
  <style>
    .booking-status {
      min-width: 100px;
      display: inline-block;
      text-align: center;
    }
    .date-cell {
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <aside class="col-md-3 col-lg-2 sidebar py-4">
        <h5 class="text-center text-uppercase mb-4">RentUp Admin</h5>
        <a href="admin.html"><i class="bi bi-house-door"></i> Dashboard</a>
        <a href="properties.html"><i class="bi bi-building"></i> Properties</a>
        <a href="bookings.html" class="active"><i class="bi bi-calendar-event"></i> Bookings</a>
        <a href="users.html"><i class="bi bi-people"></i> Users</a>
        <a href="payments.html"><i class="bi bi-currency-dollar"></i> Payments</a>
        <a href="settings.html"><i class="bi bi-gear"></i> Settings</a>
      </aside>

      <main class="col-md-9 col-lg-10">
        <div class="dashboard-header d-flex justify-content-between align-items-center">
          <h4>Bookings Management</h4>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bookingModal" onclick="prepareAddBooking()">
            <i class="bi bi-plus-circle"></i> Add Booking
          </button>
        </div>

        <div class="container-fluid py-4">
          <div class="row mb-4">
            <div class="col-md-8">
              <div class="input-group">
                <input type="text" id="bookingSearch" class="form-control" placeholder="Search bookings..." 
                       oninput="filterBookings()">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  <i class="bi bi-funnel"></i> Filters
                </button>
                <ul class="dropdown-menu dropdown-menu-end p-3" style="width: 300px;">
                  <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="filterStatus">
                      <option value="">All Statuses</option>
                      <option value="Confirmed">Confirmed</option>
                      <option value="Pending">Pending</option>
                      <option value="Cancelled">Cancelled</option>
                      <option value="Completed">Completed</option>
                    </select>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">From Date</label>
                      <input type="date" class="form-control" id="filterFromDate">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label">To Date</label>
                      <input type="date" class="form-control" id="filterToDate">
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Property</label>
                    <select class="form-select" id="filterProperty">
                      <option value="">All Properties</option>
                      <!-- Properties will be dynamically inserted -->
                    </select>
                  </div>
                  <button class="btn btn-primary w-100" onclick="applyBookingFilters()">Apply Filters</button>
                </ul>
              </div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead>
                    <tr>
                      <th>Booking ID</th>
                      <th>Property</th>
                      <th>Guest</th>
                      <th>Check In</th>
                      <th>Check Out</th>
                      <th>Nights</th>
                      <th>Total</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="bookingsTable">
                    <!-- Bookings will be dynamically inserted here -->
                  </tbody>
                </table>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted" id="bookingCount">Showing 0 bookings</div>
                <nav>
                  <ul class="pagination pagination-sm" id="bookingPagination">
                    <!-- Pagination will be inserted here -->
                  </ul>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Booking Modal (Add/Edit) -->
  <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bookingModalLabel">Add New Booking</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="bookingForm">
            <input type="hidden" id="bookingId">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="bookingProperty" class="form-label">Property*</label>
                  <select class="form-select" id="bookingProperty" required>
                    <option value="">Select Property</option>
                    <!-- Properties will be dynamically inserted -->
                  </select>
                </div>
                <div class="mb-3">
                  <label for="bookingGuest" class="form-label">Guest*</label>
                  <select class="form-select" id="bookingGuest" required>
                    <option value="">Select Guest</option>
                    <!-- Users will be dynamically inserted -->
                  </select>
                </div>
                <div class="mb-3">
                  <label for="bookingStatus" class="form-label">Status*</label>
                  <select class="form-select" id="bookingStatus" required>
                    <option value="Confirmed">Confirmed</option>
                    <option value="Pending">Pending</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="bookingCheckIn" class="form-label">Check In Date*</label>
                  <input type="date" class="form-control" id="bookingCheckIn" required 
                         onchange="calculateBookingDetails()">
                </div>
                <div class="mb-3">
                  <label for="bookingCheckOut" class="form-label">Check Out Date*</label>
                  <input type="date" class="form-control" id="bookingCheckOut" required 
                         onchange="calculateBookingDetails()">
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="bookingNights" class="form-label">Nights</label>
                    <input type="number" class="form-control" id="bookingNights" readonly>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="bookingTotal" class="form-label">Total Amount</label>
                    <input type="number" class="form-control" id="bookingTotal" readonly>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="bookingNotes" class="form-label">Notes</label>
                  <textarea class="form-control" id="bookingNotes" rows="2"></textarea>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="deleteBookingBtn" style="display: none;" 
                  onclick="confirmDeleteBooking()">
            <i class="bi bi-trash"></i> Delete
          </button>
          <button type="button" class="btn btn-primary" id="saveBookingBtn" onclick="saveBooking()">Save Booking</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteBookingConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this booking? This action cannot be undone.</p>
          <p class="text-danger"><strong>Warning:</strong> Any associated payments will also be removed.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="deleteBooking()">Delete Booking</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="app.js"></script>
  <script>
    // Current page for pagination
    let currentBookingPage = 1;
    const bookingsPerPage = 5;
    let currentBookingFilters = {};

    // Load bookings when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadPropertiesForFilter();
      loadBookings();
    });

    function loadPropertiesForFilter() {
      const properties = rentalAdmin.getProperties();
      const propertySelect = document.getElementById('filterProperty');
      const bookingPropertySelect = document.getElementById('bookingProperty');
      
      propertySelect.innerHTML = '<option value="">All Properties</option>';
      bookingPropertySelect.innerHTML = '<option value="">Select Property</option>';
      
      properties.forEach(property => {
        const option = document.createElement('option');
        option.value = property.id;
        option.textContent = `${property.name} (${property.type})`;
        propertySelect.appendChild(option.cloneNode(true));
        bookingPropertySelect.appendChild(option);
      });
    }

    function loadUsersForBooking() {
      const users = rentalAdmin.getUsers().filter(user => user.role === 'Tenant');
      const guestSelect = document.getElementById('bookingGuest');
      
      guestSelect.innerHTML = '<option value="">Select Guest</option>';
      
      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = `${user.name} (${user.email})`;
        guestSelect.appendChild(option);
      });
    }

    function loadBookings(page = 1, filters = {}) {
      currentBookingPage = page;
      currentBookingFilters = filters;
      
      const allBookings = rentalAdmin.getBookings();
      let filteredBookings = [...allBookings];

      // Apply filters
      if (filters.search) {
        const searchTerm = filters.search.toLowerCase();
        filteredBookings = filteredBookings.filter(booking => 
          booking.id.toLowerCase().includes(searchTerm)
        );
      }

      if (filters.status) {
        filteredBookings = filteredBookings.filter(b => b.status === filters.status);
      }

      if (filters.fromDate) {
        filteredBookings = filteredBookings.filter(b => new Date(b.checkIn) >= new Date(filters.fromDate));
      }

      if (filters.toDate) {
        filteredBookings = filteredBookings.filter(b => new Date(b.checkOut) <= new Date(filters.toDate));
      }

      if (filters.propertyId) {
        filteredBookings = filteredBookings.filter(b => b.propertyId == filters.propertyId);
      }

      // Update count display
      document.getElementById('bookingCount').textContent = 
        `Showing ${filteredBookings.length} bookings`;

      // Pagination
      const totalPages = Math.ceil(filteredBookings.length / bookingsPerPage);
      const startIndex = (page - 1) * bookingsPerPage;
      const paginatedBookings = filteredBookings.slice(startIndex, startIndex + bookingsPerPage);

      // Render table
      const bookingsTable = document.getElementById('bookingsTable');
      bookingsTable.innerHTML = '';

      if (paginatedBookings.length === 0) {
        bookingsTable.innerHTML = `
          <tr>
            <td colspan="9" class="text-center py-4 text-muted">
              <i class="bi bi-calendar" style="font-size: 2rem;"></i>
              <p class="mt-2">No bookings found</p>
            </td>
          </tr>
        `;
      } else {
        paginatedBookings.forEach(booking => {
          const property = rentalAdmin.getPropertyById(booking.propertyId);
          const guest = rentalAdmin.getUserById(booking.tenantId);
          
          // Calculate nights
          const checkInDate = new Date(booking.checkIn);
          const checkOutDate = new Date(booking.checkOut);
          const nights = Math.round((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${booking.id}</strong></td>
            <td>${property.name}</td>
            <td>${guest.name}</td>
            <td class="date-cell">${booking.checkIn}</td>
            <td class="date-cell">${booking.checkOut}</td>
            <td>${nights}</td>
            <td>$${booking.total}</td>
            <td>
              <span class="badge ${getBookingStatusBadgeClass(booking.status)} booking-status">
                ${booking.status}
              </span>
            </td>
            <td>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" 
                        onclick="editBooking('${booking.id}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="showBookingDeleteConfirm('${booking.id}')">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          `;
          bookingsTable.appendChild(row);
        });
      }

      // Render pagination
      renderBookingPagination(totalPages, page, 'bookingPagination', loadBookings);
    }

    function renderBookingPagination(totalPages, currentPage, elementId, callback) {
      const pagination = document.getElementById(elementId);
      pagination.innerHTML = '';

      if (totalPages <= 1) return;

      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" onclick="callback(${currentPage - 1}, currentBookingFilters)">&laquo;</a>`;
      pagination.appendChild(prevLi);

      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      if (startPage > 1) {
        const li = document.createElement('li');
        li.className = 'page-item';
        li.innerHTML = `<a class="page-link" href="#" onclick="callback(1, currentBookingFilters)">1</a>`;
        pagination.appendChild(li);
        if (startPage > 2) {
          const dotsLi = document.createElement('li');
          dotsLi.className = 'page-item disabled';
          dotsLi.innerHTML = '<span class="page-link">...</span>';
          pagination.appendChild(dotsLi);
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="callback(${i}, currentBookingFilters)">${i}</a>`;
        pagination.appendChild(li);
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const dotsLi = document.createElement('li');
          dotsLi.className = 'page-item disabled';
          dotsLi.innerHTML = '<span class="page-link">...</span>';
          pagination.appendChild(dotsLi);
        }
        const li = document.createElement('li');
        li.className = 'page-item';
        li.innerHTML = `<a class="page-link" href="#" onclick="callback(${totalPages}, currentBookingFilters)">${totalPages}</a>`;
        pagination.appendChild(li);
      }

      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" onclick="callback(${currentPage + 1}, currentBookingFilters)">&raquo;</a>`;
      pagination.appendChild(nextLi);
    }

    function getBookingStatusBadgeClass(status) {
      switch(status) {
        case 'Confirmed': return 'bg-success';
        case 'Pending': return 'bg-warning text-dark';
        case 'Cancelled': return 'bg-danger';
        case 'Completed': return 'bg-primary';
        default: return 'bg-secondary';
      }
    }

    function filterBookings() {
      const searchTerm = document.getElementById('bookingSearch').value;
      loadBookings(1, {...currentBookingFilters, search: searchTerm});
    }

    function applyBookingFilters() {
      const filters = {
        status: document.getElementById('filterStatus').value,
        fromDate: document.getElementById('filterFromDate').value,
        toDate: document.getElementById('filterToDate').value,
        propertyId: document.getElementById('filterProperty').value
      };
      loadBookings(1, {...currentBookingFilters, ...filters});
    }

    function prepareAddBooking() {
      document.getElementById('bookingModalLabel').textContent = 'Add New Booking';
      document.getElementById('bookingForm').reset();
      document.getElementById('bookingId').value = '';
      document.getElementById('deleteBookingBtn').style.display = 'none';
      document.getElementById('saveBookingBtn').textContent = 'Add Booking';
      
      loadUsersForBooking();
      
      // Set default dates (today and tomorrow)
      const today = new Date();
      const tomorrow = new Date();
      tomorrow.setDate(today.getDate() + 1);
      
      document.getElementById('bookingCheckIn').valueAsDate = today;
      document.getElementById('bookingCheckOut').valueAsDate = tomorrow;
      
      calculateBookingDetails();
    }

    function calculateBookingDetails() {
      const checkIn = document.getElementById('bookingCheckIn').value;
      const checkOut = document.getElementById('bookingCheckOut').value;
      const propertyId = document.getElementById('bookingProperty').value;
      
      if (!checkIn || !checkOut || !propertyId) return;
      
      const checkInDate = new Date(checkIn);
      const checkOutDate = new Date(checkOut);
      
      // Validate dates
      if (checkOutDate <= checkInDate) {
        alert('Check out date must be after check in date');
        document.getElementById('bookingCheckOut').value = '';
        return;
      }
      
      // Calculate nights
      const nights = Math.round((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
      document.getElementById('bookingNights').value = nights;
      
      // Calculate total
      const property = rentalAdmin.getPropertyById(parseInt(propertyId));
      if (property) {
        const total = nights * property.price;
        document.getElementById('bookingTotal').value = total.toFixed(2);
      }
    }

    function editBooking(id) {
      const booking = rentalAdmin.getBookings().find(b => b.id === id);
      if (!booking) return;

      document.getElementById('bookingModalLabel').textContent = 'Edit Booking';
      document.getElementById('bookingId').value = booking.id;
      document.getElementById('bookingProperty').value = booking.propertyId;
      document.getElementById('bookingGuest').value = booking.tenantId;
      document.getElementById('bookingStatus').value = booking.status;
      document.getElementById('bookingCheckIn').value = booking.checkIn;
      document.getElementById('bookingCheckOut').value = booking.checkOut;
      document.getElementById('bookingNotes').value = booking.notes || '';
      
      // Calculate and set nights and total
      const checkInDate = new Date(booking.checkIn);
      const checkOutDate = new Date(booking.checkOut);
      const nights = Math.round((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
      document.getElementById('bookingNights').value = nights;
      document.getElementById('bookingTotal').value = booking.total;
      
      document.getElementById('deleteBookingBtn').style.display = 'inline-block';
      document.getElementById('saveBookingBtn').textContent = 'Update Booking';
      
      loadUsersForBooking();
      
      const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
      modal.show();
    }

    function saveBooking() {
      const id = document.getElementById('bookingId').value;
      const propertyId = parseInt(document.getElementById('bookingProperty').value);
      const tenantId = parseInt(document.getElementById('bookingGuest').value);
      const status = document.getElementById('bookingStatus').value;
      const checkIn = document.getElementById('bookingCheckIn').value;
      const checkOut = document.getElementById('bookingCheckOut').value;
      const total = parseFloat(document.getElementById('bookingTotal').value);
      const notes = document.getElementById('bookingNotes').value;
      
      const bookingData = {
        propertyId,
        tenantId,
        status,
        checkIn,
        checkOut,
        total,
        notes
      };

      const data = rentalAdmin.getData();
      
      if (id) {
        // Update existing booking
        const index = data.bookings.findIndex(b => b.id === id);
        if (index !== -1) {
          data.bookings[index] = {...data.bookings[index], ...bookingData};
        }
      } else {
        // Add new booking
        const property = rentalAdmin.getPropertyById(propertyId);
        const newId = 'B' + (1000 + data.bookings.length + 1).toString().substring(1);
        bookingData.id = newId;
        data.bookings.push(bookingData);
        
        // Add associated payment if status is Confirmed
        if (status === 'Confirmed') {
          data.payments.push({
            bookingId: newId,
            tenantId,
            propertyId,
            amount: total,
            status: 'Completed',
            date: new Date().toISOString().split('T')[0]
          });
        }
      }
      
      rentalAdmin.saveData(data);
      
      // Close modal and refresh list
      const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
      modal.hide();
      
      loadBookings(currentBookingPage, currentBookingFilters);
    }

    function showBookingDeleteConfirm(id) {
      document.getElementById('bookingId').value = id;
      const modal = new bootstrap.Modal(document.getElementById('deleteBookingConfirmModal'));
      modal.show();
    }

    function confirmDeleteBooking() {
      const id = document.getElementById('bookingId').value;
      showBookingDeleteConfirm(id);
    }

    function deleteBooking() {
      const id = document.getElementById('bookingId').value;
      if (!id) return;

      const data = rentalAdmin.getData();
      
      // Remove booking
      data.bookings = data.bookings.filter(booking => booking.id !== id);
      
      // Remove associated payment
      data.payments = data.payments.filter(payment => payment.bookingId !== id);
      
      rentalAdmin.saveData(data);
      
      // Close modals and refresh list
      const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteBookingConfirmModal'));
      deleteModal.hide();
      
      const bookingModal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
      bookingModal.hide();
      
      loadBookings(currentBookingPage, currentBookingFilters);
    }
  </script>
</body>
</html>